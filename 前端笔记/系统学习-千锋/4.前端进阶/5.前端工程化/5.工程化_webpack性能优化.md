优化方案：减少构建⽬标（include, exclude）提升构建速度，使⽤多进程优化构建速度，使⽤分包减少构建⽂件体积，



#### 1. 构建速度的测量插件 speed-measure-webpack-plugin

使用插件，显示每个 loader 和 plugin 执⾏时间，会将⽐较耗时的⽤红⾊标记出来。

插件地址：https://github.com/webpack-contrib/thread-loader

安装：`npm i speed-measure-webpack-plugin -D`

使用：用 .wrap 方法包裹 webpack 配置

```js
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin')
const smp = new SpeedMeasurePlugin({
  disable: !process.env.MEASURE, // 是否使用该插件，false 表示使用
  outputFormat: 'humanVerbose', // 显示更详细的信息
  loaderTopFiles: 2, // 显示耗费时间最长的两个文件
});
smp.wrap(webpackConfig)
```

对于 vue 来说就是：

```js
// vue.config.js
module.exports = defineConfig({
  transpileDependencies: true,
  configureWebpack: smp.wrap({}), // 大括号里就是写 webpack 配置的，如 resolve, plugins 等
});
```

这样在 npm run build 时就会将打包时间及文件大小打印出来



#### 2. 构建体积检测插件 webpack-bundle-analyzer

webpack-bundle-analyzer 是 webpack 的插件，需要配合 webpack 和 webpack-cli ⼀起使⽤。这个插件可以读取 output ⽂件夹中的 stats.json ⽂件，把该⽂件通过网页形式可视化展现，⽣成代码分析报告，可以直观地分析打包出的⽂件有哪些，及它们的⼤⼩、占⽐情况、各⽂件 Gzipped 后的⼤⼩、模块包含关系、依赖项等。

通过分析图可帮助我们了解 bundle 包中的真正内容、找出哪些模块尺⼨最⼤、查找误引⼊的模块、优化项⽬等

插件地址：https://github.com/webpack-contrib/webpack-bundle-analyzer

安装：`npm install webpack-bundle-analyzer -D`

使用：

```js
const { BundleAnalyzerPlugin } = require("webpack-bundle-analyzer");

  configureWebpack: smp.wrap({
    plugins: [
      new BundleAnalyzerPlugin({
        analyzerMode: "static", // 生成静态文件 report.html 
      }),
    ],
  }),
```



#### 3. 构建性能优化之多进程 thread-loader

对于耗时的操作可使用此 loader ，使⽤多进程来并发去处理任务，从⽽提升构建效率

插件地址：https://github.com/webpack-contrib/thread-loader

安装：`npm install thread-loader -D`

使用：

```js
rules: [
  {
    test: /\.js$/,
    include: path.resolve(__dirname, 'src'), // 减少构建目标，限制要处理的文件只包含 src 文件夹，否则会包含 node_modules 文件夹
    use: [
      'thread-loader', // 应该放到其他 loader 的前面
      // 耗时的 loader（例如 babel-loader）
    ],
  },
],
```

vue 内部已经启动了 thread-loader ，故不需要我们手动配置，只需要添加配置：

```js
module.exports = defineConfig({
  parallel: true, // 和 configureWebpack 同级
})
```



#### 4. 分包

在 webpack 打包过程中，经常出现 vendor.js， app.js 单个⽂件较⼤的情况，==这偏偏⼜是⽹⻚最先加载的⽂件，这就会使得加载时间过⻓，从⽽使得⽩屏时间过⻓，影响⽤户体验==。因此我们需要将打包⽂件进⼀步优化 - 分包。把变化⼏率很⼩的第三⽅库抽离出来，提前打包好，使⽤ DllPlugin 进⾏分包。

分包：新建 build 文件夹，下建 webpack.dll.config.js 文件，==使⽤ DllPlugin 进⾏分包==

```js
const path = require("path");
const webpack = require("webpack");

module.exports = {
  mode: "production",
  entry: {
    vue: ["vue", "vuex", "vue-router"], // 要抽离的第三方库，一般是package.json中 dependencies中较大的库
  },
  output: {
    path: path.resolve(__dirname, "../dll"),
    filename: "[name].dll.js",
    library: "[name]_[hash]",
  },
  plugins: [
    new webpack.DllPlugin({
      path: path.resolve(__dirname, "../dll", "[name]-manifest.json"),
      name: "[name]_[hash]",
    }),
  ],
};
```

在 package.json 中新添命令：`"build-dll": "webpack --config build/webpack.dll.config.js" ` ，运行之后会生成一个 dll 文件夹

排除分包：在 vue.config.js 中，==使⽤ DllReferencePlugin 引⽤ manifest ⽂件，排除分包==。

```js
    plugins: [
      new webpack.DllReferencePlugin({
        context: __dirname,
        manifest:path.resolve(__dirname,"./dll/vue-manifest.json")
      }) // 会通过 manifest 文件分析出哪些需要解除引用
    ],
```

==使⽤ add-asset-html-webpack-plugin 插件引⽤分包⽂件==：

```js
      new AddAssetHtmlPlugin({
        filepath: path.resolve(__dirname, "./dll/vue.dll.js"),
      }),
```



#### 5. 使用缓存提升打包性能

https://webpack.docschina.org/configuration/cache/#root

```js
module.exports = {
  cache: {
    type: 'filesystem',
    allowCollectingMemory: true,
  },
};
```



#### 6. image-webpack-loader 实现图⽚压缩

https://github.com/tcoopman/image-webpack-loader

```js
      rules: [
        {
          test: /\.(gif|png|jpe?g|svg)$/i,
          use: [
            {
              loader: "image-webpack-loader",
              options: {
                mozjpeg: {
                  progressive: true,
                  quality: 20, // 图片质量，0-100，质量越低压缩得越小
                },
                // optipng.enabled: false will disable optipng
                optipng: {
                  enabled: false,
                },
                pngquant: {
                  quality: [0.65, 0.9],
                  speed: 4,
                },
                gifsicle: {
                  interlaced: false,
                },
                // the webp option will enable WEBP
                webp: {
                  quality: 75,
                },
              },
            },
          ],
        },
      ],
```



#### 7. purgecss-webpack-plugin 优化 css 体积

在⼤型项⽬中，经常会有很多样式内容，在代码中根本未使⽤，但是会被打包，这些样式在打包时应该移除。

https://github.com/FullHuman/purgecss/tree/main/packages/purgecss-webpack-plugin





