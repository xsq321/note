#### 1. 相关知识

webpack 是一个前端资源加载/打包工具，它将根据模块的依赖关系进行静态分析，然后将这些模块按照指定的规则生成对应的静态资源；webpack 可以将多种静态资源 js, css, less 转换成一个静态文件，从而减少页面请求

核心概念：Entry, Output, Module, Chunk, Loader

官方文档：https://www.webpackjs.com/

主要功能：前端模块化开发支持、代码压缩混淆、处理浏览器 JS 兼容性问题、性能优化



#### 2. 基本使用

安装依赖：`npm i webpack webpack-cli -D`  ，webpack 相关的所有 plugin, loader 等都应该使用 -D 安装

webpack.config.js 文件：

```js
const path = require("path");

module.exports = {
  mode: "development",
  entry: "./src/index.js",
  output: {
    filename: "main.js",
    path: path.resolve(__dirname, "dist"),
  },
};
```

运行：`webpack --config webpack.config.js`   // 也可以将该行命令配置到 package.json 中的 scripts 中，如 `"build": "webpack --config webpack.config.js"` ，这样就可以直接 npm run build 运行了



#### 3. 常用 Plugin

为 webpack 提供扩展功能

| plugin              | 作用                                                         |
| ------------------- | ------------------------------------------------------------ |
| html-webpack-plugin | 打包时会自动生成一个 index.html 文件，并通过 script 标签引入 webpack 生成的所有 bundle ，css 资源则会通过 link 标签引入；需下载安装 |
| DefinePlugin        | 可以定义全局常量，可应用在为开发和生产环境设置不同的值；webpack 自带插件 |
|                     |                                                              |
|                     |                                                              |

```js
  plugins: [
    new HtmlWebpackPlugin(),
    new webpack.DefinePlugin({
      HOST: '"https://api.dev.com"', // 注意需用两个引号，或者用 JSON.stringify 包裹；HOST 可以在任意文件任意位置使用
    }),
  ],
```



#### 4. 常用 Loader 

==webpack 默认只能处理 js 文件，loader 的作用就是把其他类型的文件转换成 webpack 可以处理的模块==

| loader        | 作用                                                         |
| ------------- | ------------------------------------------------------------ |
| css-loader    | 用于处理 css 文件，使得能在 js 文件中引入使用                |
| style-loader  | 用于将 css 文件注入到 index.html 中的 style 标签上           |
| less-loader   | 处理 less 代码                                               |
| sass-loader   | 处理 sass 代码                                               |
| babel-loader  | 把 ES6 转换成 ES5                                            |
| ts-loader     | 把 ts 转换成 es5                                             |
| file-loader   | 打包图片，打包字体图标                                       |
| url-loader    | 和 file-loader 类似，当文件小于设定的 limit 时，可以将文件直接转为 base64 嵌入到 js 中 |
| eslint-loader | 用于检查常见的 js 代码错误，也可以进行代码规范检查           |
|               |                                                              |
|               |                                                              |

```js
  module: {
    rules: [  // 好像和 use 的数组一样，也是从后往前执行（相同 test, enforce 的情况下）；当然一般情况下对于相同的 test 的 loader 放一起即可，从而统一管理执行顺序
      {
        test: /\.css$/i, // 根据正则表达式去匹配文件
        use: ["style-loader", "css-loader"], // 使用 loader 处理，执行顺序为从后往前
        enforce: 'pre', // 执行顺序：前置(pre) - 普通(默认) - 行内(文件内部调用) - 后置(post)
      },
    ],
  },
```



#### 5. 打包优化

##### 5.1. 防止重复引入

解决多入口文件时，重复打包同一个模块文件，导致文件无意义的变大；因为每个入口文件是分别打包的

- 使用 shared 属性，但需手动配置 dependOn 和 shared 

```js
  entry: {
    index: { import: "./src/index.js", dependOn: "shared" },
    another: { import: "./src/another.js", dependOn: "shared" },
    shared: "lodash", // 把 index.js 和 another.js 都用到的模块 lodash 抽离出来
  },
  output: {
    filename: "[name].bundle.js", // 注意多入口文件时的写法，name 就是 entry 的键名；会生成三个文件，而 index 和 another 都依赖于 shared ，shared 引入共同模块 lodash ，这时就只会打包一次 lodash 
  },
```

- （==推荐==）使用 SplitChunksPlugin ，无须手动配置，会自动判断哪些模块可以抽离

```js
  optimization: { splitChunks: { chunks: "all" } },
```

##### 5.2. 动态导入

即异步导入，可以在文件任意位置导入，实现文件懒加载，即用到时才导入，而不是在文件开头导入所有

```js
const { default: _ } = await import('lodash') // 注意赋值的写法，这时的 import 将返回一个 promise 对象，成功时返回的是一个对象，而我们需要将其解构赋值一下，default 即 export default 的导出
```

##### 5.3. 防止文件缓存

⽂件名可以添加属性 [contenthash] ，是根据文件内容生成的 hash 值，当⽂件内容改变时就可以使文件名也改变，防⽌⽂件被缓存导致页面不更新

```js
output: {
  filename: '[name].[contenthash].js',
  clean: true,  // 自动清空旧文件
},
```



#### 6. 其他

##### 6.1. 路径别名

```js
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "src"),
    },
    extensions:['.js','.jsx','.ts'] // 不写扩展名时根据顺序一个个找相应文件，都没有则报错
  },
```



